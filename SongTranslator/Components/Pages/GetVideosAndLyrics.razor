@using SongTranslator.Services
@using SongTranslator.Components.Data
@using System.Text.Json;
@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;
@using System.Diagnostics;
@using Google.Apis.YouTube.v3
@inject Google.Apis.YouTube.v3.YouTubeService YouTubeService

<div class="input-group mb-3">
    <input @bind="artistName" class="form-control" placeholder="Artist Name" />
    <input @bind="songName" class="form-control" placeholder="Song Name" />
    <button class="btn btn-primary" @onclick="GetResult">Search</button>
</div>


<p>@errorMessageYoutube</p>
<p>@errorMessageLyrics</p>
<p>@errorMessageInput</p>

@if (loading)
{
    <div>
        <p>Loading...</p>
    </div>
}

<div class="video-lyrics-container">

    @* Display video *@
    @if (videos.Any())
    {
        <div class="single-video-box">
            <iframe width="640" height="360"
            src="https://www.youtube.com/embed/@videos.First().VideoId?autoplay=1"
            frameborder="0" />
        </div>
    }
    else
    {
        <div class="single-video-box-placeholder">
            <p>No video here yet :D</p>
        </div>
    }

    @* Display lyrics *@
    @if (!lyrics.Equals("Response is null") && !string.IsNullOrEmpty(lyrics))
    {

        <div class="lyrics-container">
            <p>@lyrics</p>
        </div>
    }else{
        <div class="lyrics-box-placeholder">
            <p>No lyrics here yet :D</p>
        </div>
    }
</div>

@* Display recommended videos *@

@if (videos.Any())
{
    <h3 class="display-4">Recommended:</h3>
    <div class="row">
        @foreach (var video in videos.Skip(1))
        {
            <div class="col">
                <figure class="figure">
                    <a href="https://www.youtube.com/watch?v=@video.VideoId" title="@video.Title">
                        <img src="@video.Thumbnail" class="figure-img img-fluid rounded" alt="@video.Title">
                    </a>
                    <figcaption class="figure-caption">@video.Title</figcaption>
                </figure>
            </div>
        }
    </div>
}




<div>
    @foreach (var media in fetchedLyricsVideo)
    {
        <div>
            <h4>TITLE: @media.Title</h4>

            @if (media.Source == MediaSourceEnum.YouTubeVideo && media is YouTubeVideo video)
            {
                <h4>Youtube Video url: @video.Url</h4>
            }

            @if (media.Source == MediaSourceEnum.Lyrics && media is SongLyrics lyrics)
            {
                <p>@lyrics.Lyrics</p>
            }
        </div>
    }
</div>


@code {
    private FetchLyricsService lyricsService = new FetchLyricsService();
    private List<YouTubeVideo> videos = new List<YouTubeVideo>();

    private List<MediaData> fetchedLyricsVideo = new List<MediaData>();

    private string artistName = "";
    private string songName = "";
    private string searchQuery = "";

    private string lyrics = "";

    private string errorMessageYoutube = "";
    private string errorMessageLyrics = "";
    private string errorMessageInput = "";

    private bool loading = false;

    private async Task SearchYouTube()
    {

        await Task.Delay(300);
        videos.Clear();

        try
        {
            searchQuery = artistName + " " + songName;
            var searchListRequest = YouTubeService.Search.List("snippet");
            searchListRequest.Q = searchQuery;
            searchListRequest.Type = "video";
            searchListRequest.MaxResults = 6;
            searchListRequest.Order = SearchResource.ListRequest.OrderEnum.Relevance;


            searchListRequest.Order = Google.Apis.YouTube.v3.SearchResource.ListRequest.OrderEnum.Relevance;

            var searchListResponse = await searchListRequest.ExecuteAsync();

            if (searchListResponse.Items == null || !searchListResponse.Items.Any() )
            {
                errorMessageYoutube = "Hmm... No Youtube results found for this song.";
                return;
            }

            videos.AddRange(searchListResponse.Items.Select(video => new YouTubeVideo
                {
                    Title = video.Snippet.Title,
                    Thumbnail = video.Snippet.Thumbnails?.High?.Url ?? "",
                    VideoId = video.Id.VideoId,
                    Source = MediaSourceEnum.YouTubeVideo
                }));

            fetchedLyricsVideo.AddRange(videos);

        }
        catch (Exception ex)
        {
            errorMessageYoutube = ex.Message;
        }
    }


    private async Task FetchLyrics()
    {
        // debugMessage = "clicked";
        Console.WriteLine("clicked");
        try
        {

            lyrics = await lyricsService.LyricsTextAsync(artistName, songName);

            if (string.IsNullOrEmpty(lyrics) || lyrics.Equals("Response is null") || lyrics.Equals("Unexpected character encountered while parsing value: <. Path '', line 0, position 0."))
            {

                lyrics = "Hmm... No lyrics found for this song.";
                errorMessageLyrics = "Hmm... No lyrics found for this song.";
                return;
            }

            var singleSongLyrics = new SongLyrics
                {
                    Artist = artistName,
                    SongName = songName,
                    Lyrics = lyrics,
                    Title = songName,
                    Source = MediaSourceEnum.Lyrics
                };

            fetchedLyricsVideo.Add(singleSongLyrics);
        }
        catch (Exception ex)
        {
            // errorMessageLyrics = ex.Message;
            lyrics = "Hmm... No lyrics found for this song.";

        }
    }

    private bool ValidateInput()
    {
        if (string.IsNullOrEmpty(artistName) || string.IsNullOrEmpty(songName))
        {
            errorMessageInput = "Search must be filled in.";
            return false;
        }
        else
        {
            return true;
        }
    }

    private async Task GetResult()
    {
        errorMessageInput = "";
        errorMessageYoutube = "";
        errorMessageLyrics = "";
        lyrics = "";
        videos.Clear();


        if (ValidateInput())
        {
            try
            {
                loading = true;
                await SearchYouTube();
                StateHasChanged();

                await FetchLyrics();
                StateHasChanged();

            }
            finally
            {

                loading = false;

                StateHasChanged();

            }
        }
        else
        {
            return;
        }
    }
}
